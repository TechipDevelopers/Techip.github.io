<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Techip Admin — Users · Devices · Features (Debug)</title>
  <style>
    :root{
      --brand:#0b3d91; --muted:#6b7280; --bg:#f7f9fc; --card:#ffffff;
      --radius:12px; --gap:16px; font-family:Inter,system-ui,Roboto,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#0b1a2b;padding:24px}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .login-card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(11,61,145,0.08);border:1px solid #e6eef8;display:flex;gap:12px;align-items:center;justify-content:center}
    input{padding:10px;border-radius:10px;border:1px solid #e6eef8;background:#fbfdff;font-size:15px}
    button{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #e6eef8;color:#0b1a2b}
    .muted{color:var(--muted);font-size:13px}
    .main{display:flex;gap:18px;margin-top:18px}
    .panel{background:var(--card);flex:1;padding:14px;border-radius:var(--radius);border:1px solid #e6eef8;min-height:360px}
    .panel.small{width:320px;flex:0 0 320px}
    .list{list-style:none;padding:0;margin:0}
    .list li{padding:10px;border-radius:10px;border:1px solid transparent;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .list li:hover{background:#f1f8ff;border-color:#e2f0ff}
    .list li.selected{background:#e8f3ff;border-color:#cfe9ff}
    .empty{padding:18px;text-align:center;color:var(--muted)}
    .device-name{font-weight:600}
    .features{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .feature{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid #f1f5f9;background:#fff}
    .feature .label{font-size:14px}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input{width:20px;height:20px}
    #debug{margin-top:12px;background:#0b1a2b;color:#fff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;max-height:180px;overflow:auto}
    .top-right{display:flex;gap:8px;align-items:center}
    .small-form {margin-bottom:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .small-form input {width:150px}
    .small-form .tiny {padding:8px 10px;border-radius:8px}
    @media(max-width:980px){ .main{flex-direction:column} .panel.small{width:100%} .wrap{padding:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Techip Admin</h1>
        <div class="muted">Admin login required to view users, devices, and features</div>
      </div>
      <div class="top-right">
        <div id="signed-as" class="muted" style="display:none"></div>
        <button id="signout-btn" class="ghost" style="display:none">Sign out</button>
      </div>
    </header>

    <!-- login card -->
    <div id="login-area" class="login-card" role="region" aria-label="Admin login">
      <input id="email" type="email" placeholder="admin@example.com" style="width:320px" />
      <input id="password" type="password" placeholder="Password" style="width:220px" />
      <button id="signin-btn">Admin Sign in</button>
      <!-- show-session button appended by script -->
    </div>

    <!-- main app -->
    <div id="app" style="display:none" class="main" aria-hidden="true">
      <aside class="panel small" aria-label="Users list">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Users</strong>
          <div>
            <button id="refresh-profiles" class="ghost">Refresh</button>
          </div>
        </div>

        <!-- Add user form (above Refresh) -->
        <div id="add-user-area" style="margin-bottom:12px">
          <div class="small-form" aria-hidden="false">
            <input id="new-email" type="email" placeholder="email" />
            <input id="new-password" type="password" placeholder="password (for auth)" />
            <button id="create-auth-user-btn" class="tiny">Create Auth</button>
            <button id="create-profile-only-btn" class="tiny">Profile Only</button>
          </div>
          <div id="add-user-msg" class="muted" style="font-size:13px"></div>
        </div>

        <div id="profiles-empty" class="empty">Sign in as admin to load users</div>
        <ul id="profiles-list" class="list" aria-live="polite"></ul>
      </aside>

      <section class="panel" aria-label="Devices list">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <strong id="devices-title">Devices</strong>
            <div id="devices-sub" class="muted">Select a user to view their devices</div>
          </div>
          <div>
            <button id="refresh-devices" class="ghost">Refresh</button>
            <button id="create-device-btn" class="ghost">Create device</button>
          </div>
        </div>

        <div id="devices-empty" class="empty">No user selected</div>
        <table id="devices-table" style="width:100%;border-collapse:collapse;display:none">
          <thead><tr style="text-align:left;color:var(--muted)"><th style="width:90px">ID</th><th>Name</th><th style="width:140px">Model</th><th style="width:160px">Features</th></tr></thead>
          <tbody id="devices-body"></tbody>
        </table>
      </section>

      <aside class="panel small" aria-label="Device features">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong id="feature-title">Device Features</strong>
        </div>
        <div id="feature-sub" class="muted">Select a device to edit features</div>
        <div id="selected-device" style="margin-top:12px"></div>
        <div id="features-list" class="features" style="margin-top:12px"></div>
        <div style="margin-top:10px"><button id="apply-all" class="ghost" style="display:none">Apply All (save)</button></div>
        <div id="debug">Ready.</div>
      </aside>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // CONFIG
    const SUPABASE_URL = 'https://cnwerkocgdhimiwuawiv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNud2Vya29jZ2RoaW1pd3Vhd2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTMwMjAsImV4cCI6MjA3NzY2OTAyMH0.X0ewxmFBh2ofhIQGPgDucJk9pQJylXDoLTerxYgrouw';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    // DOM
    const loginArea = document.getElementById('login-area');
    const signinBtn = document.getElementById('signin-btn');
    const signoutBtn = document.getElementById('signout-btn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const app = document.getElementById('app');
    const signedAs = document.getElementById('signed-as');

    const profilesList = document.getElementById('profiles-list');
    const profilesEmpty = document.getElementById('profiles-empty');
    const refreshProfilesBtn = document.getElementById('refresh-profiles');

    const newEmail = document.getElementById('new-email');
    const newPassword = document.getElementById('new-password');
    const createAuthBtn = document.getElementById('create-auth-user-btn');
    const createProfileBtn = document.getElementById('create-profile-only-btn');
    const addMsg = document.getElementById('add-user-msg');

    const devicesTitle = document.getElementById('devices-title');
    const devicesSub = document.getElementById('devices-sub');
    const devicesTable = document.getElementById('devices-table');
    const devicesBody = document.getElementById('devices-body');
    const devicesEmpty = document.getElementById('devices-empty');
    const refreshDevicesBtn = document.getElementById('refresh-devices');

    const featuresList = document.getElementById('features-list');
    const selectedDeviceEl = document.getElementById('selected-device');
    const featureTitle = document.getElementById('feature-title');
    const featureSub = document.getElementById('feature-sub');
    const debugEl = document.getElementById('debug');
    const applyAllBtn = document.getElementById('apply-all');

    function log(...args){ console.log(...args); debugEl.textContent = args.map(a=> typeof a==='object' ? JSON.stringify(a,null,2) : String(a)).join(' '); }
    function escapeHtml(s){ if (s == null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    const FEATURE_MAP = [
      { key: 'block_play_store', label: 'Block Google Play Store' },
      { key: 'block_developer_options', label: 'Block Developer Options' },
      { key: 'disable_app_settings', label: 'Disable App Settings Control' },
      { key: 'disable_apk_installation', label: 'Disable APK Installation' },
      { key: 'disable_bluetooth', label: 'Disable Bluetooth' },
      { key: 'disable_tethering', label: 'Disable Tethering & Hotspot' },
      { key: 'disable_sms_mms', label: 'Disable SMS/MMS' },
      { key: 'enable_firewall', label: 'Enable Firewall (VPN)' },
      { key: 'enable_private_dns', label: 'Enable Private DNS' },
      { key: 'disable_all_network', label: 'Disable All Network Access' },
      { key: 'disallow_adding_users', label: 'Disallow Adding Users' },
      { key: 'disable_factory_reset', label: 'Disable Factory Reset' },
      { key: 'block_whatsapp_updates_tab', label: 'Block WhatsApp Updates Tab' },
      { key: 'block_inapp_ai_chats', label: 'Block In-App AI Chats' }
    ];

    // State
    let profiles = [], selectedProfile = null, devices = [], selectedDevice = null, editingFeatures = {};

    // Add "Show session" debug button into login-area
    (function addShowSessionBtn(){
      const btn = document.createElement('button');
      btn.textContent = 'Show session';
      btn.className = 'ghost';
      btn.style.marginLeft = '8px';
      btn.addEventListener('click', async () => {
        try {
          const { data } = await supabase.auth.getSession();
          log('Session:', data);
        } catch (e) {
          log('Error reading session:', (e && e.message) || e);
        }
      });
      loginArea.appendChild(btn);
    })();

    // Auth handlers
    signinBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) { alert('Email and password required'); return; }

      signinBtn.disabled = true;
      try {
        const res = await supabase.auth.signInWithPassword({ email, password });
        log('signIn ->', res);
        if (res.error) {
          alert('Sign-in failed: ' + res.error.message);
          return;
        }
        const { data: { user } } = await supabase.auth.getUser();
        await onAuth(user);
      } catch (err) {
        log('sign-in exception', err);
        alert('Sign-in exception: ' + (err.message || err));
      } finally {
        signinBtn.disabled = false;
      }
    });

    signoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      await onAuth(null);
    });

    supabase.auth.onAuthStateChange(async (evt, session) => {
      log('auth state change: ' + evt);
      await onAuth(session?.user ?? null);
    });

    async function onAuth(user) {
      if (!user) {
        app.style.display = 'none';
        app.setAttribute('aria-hidden', 'true');
        loginArea.style.display = 'flex';
        signedAs.style.display = 'none';
        signoutBtn.style.display = 'none';
        signedAs.textContent = '';
        profilesList.innerHTML = '';
        devicesBody.innerHTML = '';
        featuresList.innerHTML = '';
        profilesEmpty.textContent = 'Sign in as admin to load users';
        log('Signed out');
        return;
      }

      loginArea.style.display = 'none';
      app.style.display = 'flex';
      app.removeAttribute('aria-hidden');
      signedAs.style.display = 'inline-block';
      signedAs.textContent = 'Signed in as ' + (user.email || user.id);
      signoutBtn.style.display = 'inline-block';

      await loadProfiles();
    }

    // Profiles
    refreshProfilesBtn.addEventListener('click', loadProfiles);

    async function loadProfiles() {
      profilesEmpty.textContent = 'Loading users…';
      profilesList.innerHTML = '';
      try {
        // ensure session present before query
        const { data: sessionData } = await supabase.auth.getSession();
        log('loadProfiles session present:', !!sessionData?.session?.access_token);
        if (!sessionData?.session?.access_token) {
          log('No session — forcing UI reset');
          await supabase.auth.signOut();
          await onAuth(null);
          return;
        }

        const { data, error } = await supabase.from('profiles').select('id,email,created_at,is_admin').order('created_at', { ascending: false }).limit(2000);
        if (error) throw error;
        profiles = data || [];
        renderProfiles();
        profilesEmpty.style.display = profiles.length ? 'none' : 'block';
        if (!profiles.length) profilesEmpty.textContent = 'No users found';
        log('profiles loaded: ' + (profiles.length));
      } catch (err) {
        profilesEmpty.textContent = 'Failed to load';
        log('loadProfiles err', err);
        alert('Failed loading users: ' + (err.message || err));
      }
    }

    function renderProfiles() {
      profilesList.innerHTML = '';
      if (!profiles.length) {
        profilesEmpty.style.display = 'block';
        profilesEmpty.textContent = 'No users';
        return;
      }
      profilesEmpty.style.display = 'none';
      profiles.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `<div>${escapeHtml(p.email || p.id)}</div><div class="muted" style="font-size:12px">${p.is_admin ? 'admin' : ''}</div>`;
        li.addEventListener('click', () => selectProfile(p, li));
        profilesList.appendChild(li);
      });
    }

    // Add user handlers (two flows)
    function showAddMsg(text, isError = false) {
      addMsg.textContent = text;
      addMsg.style.color = isError ? 'crimson' : '#0a0';
      setTimeout(() => { addMsg.textContent = '' }, 5000);
    }

    createAuthBtn.addEventListener('click', async () => {
      const email = newEmail.value.trim();
      const password = newPassword.value;
      if (!email || !password) { showAddMsg('Provide email and password', true); return; }

      createAuthBtn.disabled = true;
      showAddMsg('Creating auth user...');
      try {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) {
          showAddMsg('Auth create error: ' + error.message, true);
          createAuthBtn.disabled = false;
          return;
        }
        const userId = data?.user?.id;
        if (userId) {
          const { error: profileErr } = await supabase
            .from('profiles')
            .upsert({ id: userId, email, is_admin: false, created_at: new Date().toISOString() });
          if (profileErr) {
            showAddMsg('Profile upsert error: ' + profileErr.message, true);
            createAuthBtn.disabled = false;
            return;
          }
        }
        showAddMsg('Auth user created. Confirm email if required.');
        await loadProfiles();
      } catch (e) {
        showAddMsg('Unexpected error creating auth user', true);
        console.error(e);
      } finally {
        createAuthBtn.disabled = false;
      }
    });

    createProfileBtn.addEventListener('click', async () => {
      const email = newEmail.value.trim();
      if (!email) { showAddMsg('Provide email', true); return; }

      function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      const id = uuidv4();
      createProfileBtn.disabled = true;
      showAddMsg('Creating profile row...');
      try {
        const { data, error } = await supabase
          .from('profiles')
          .insert([{ id, email, is_admin: false, created_at: new Date().toISOString() }]);
        if (error) {
          showAddMsg('Insert error: ' + error.message, true);
          createProfileBtn.disabled = false;
          return;
        }
        showAddMsg('Profile created (id: ' + id + ')');
        await loadProfiles();
      } catch (e) {
        showAddMsg('Unexpected error inserting profile', true);
        console.error(e);
      } finally {
        createProfileBtn.disabled = false;
      }
    });

    // Devices
    async function selectProfile(profile, liEl) {
      Array.from(profilesList.children).forEach(c => c.classList.remove('selected'));
      liEl.classList.add('selected');

      selectedProfile = profile;
      devicesTitle.textContent = `Devices for ${profile.email || profile.id}`;
      devicesSub.textContent = 'Loading devices…';
      devicesBody.innerHTML = '';
      selectedDevice = null;
      featuresList.innerHTML = '';
      selectedDeviceEl.textContent = '';

      await loadDevicesForProfile(profile.id);
    }

    refreshDevicesBtn.addEventListener('click', async () => {
      if (!selectedProfile) return alert('Select a user first');
      await loadDevicesForProfile(selectedProfile.id);
    });

    async function loadDevicesForProfile(profileId) {
      devicesEmpty.style.display = 'none';
      devicesTable.style.display = 'none';
      devicesBody.innerHTML = '';
      try {
        const { data, error } = await supabase.from('devices').select('*').eq('owner', profileId).order('created_at', { ascending: false }).limit(2000);
        if (error) throw error;
        devices = data || [];
        renderDevices();
        devicesSub.textContent = `${devices.length} device(s)`;
        log('devices loaded for profile', profileId, devices.length);
      } catch (err) {
        devicesSub.textContent = 'Failed to load devices';
        log('loadDevices err', err);
        alert('Failed loading devices: ' + (err.message || err));
      }
    }

    function renderDevices() {
      devicesBody.innerHTML = '';
      if (!devices.length) {
        devicesTable.style.display = 'none';
        devicesEmpty.style.display = 'block';
        devicesEmpty.textContent = 'No devices for this user';
        return;
      }
      devicesEmpty.style.display = 'none';
      devicesTable.style.display = 'table';
      devices.forEach(d => {
        const tr = document.createElement('tr');
        const featuresPreview = escapeHtml(JSON.stringify(d.features || {}));
        tr.innerHTML = `<td style="vertical-align:middle">${escapeHtml(d.id)}</td>
                        <td style="vertical-align:middle"><span class="device-name clickable">${escapeHtml(d.name || '')}</span></td>
                        <td style="vertical-align:middle">${escapeHtml(d.model || '')}</td>
                        <td style="vertical-align:middle;max-width:180px;white-space:pre-wrap">${featuresPreview}</td>`;
        tr.querySelector('.clickable').addEventListener('click', () => selectDevice(d, tr));
        devicesBody.appendChild(tr);
      });
    }

  // Feature controls
    function selectDevice(device, trEl) {
      Array.from(devicesBody.querySelectorAll('tr')).forEach(r => r.classList.remove('selected'));
      trEl.classList.add('selected');

      selectedDevice = device;
      editingFeatures = Object.assign({}, device.features || {});
      featureTitle.textContent = device.name ? Features — ${device.name} : Features — ${device.id};
      featureSub.textContent = Device ID: ${device.id};
      selectedDeviceEl.innerHTML = <div class="muted">Model: ${escapeHtml(device.model || 'unknown')}</div>;
      renderFeatureControls();
      applyAllBtn.style.display = 'none';
    }

    function renderFeatureControls() {
      featuresList.innerHTML = '';
      FEATURE_MAP.forEach((f) => {
        const wrap = document.createElement('div'); wrap.className = 'feature';
        const left = document.createElement('div'); left.className = 'label'; left.textContent = f.label;
        const right = document.createElement('div'); right.className = 'switch';
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!editingFeatures[f.key];
        cb.addEventListener('change', async () => {
          editingFeatures[f.key] = cb.checked;
          log('toggle', f.key, cb.checked);
          try {
            await persistFeatureToggle(selectedDevice.id, f.key, cb.checked);
            selectedDevice.features = Object.assign({}, selectedDevice.features || {}, { [f.key]: cb.checked });
            renderDevices();
          } catch (err) {
            cb.checked = !!(selectedDevice.features && selectedDevice.features[f.key]);
            alert('Save failed: ' + (err.message || err));
          }
        });
        right.appendChild(cb);
        wrap.appendChild(left); wrap.appendChild(right);
        featuresList.appendChild(wrap);
      });
    }

    async function persistFeatureToggle(deviceId, key, value) {
      try {
        const { data: latest, error: getErr } = await supabase.from('devices').select('features').eq('id', deviceId).single();
        if (getErr) throw getErr;
        const featuresNow = Object.assign({}, latest?.features || {}, { [key]: value });
        const { data, error } = await supabase.from('devices').update({ features: featuresNow }).eq('id', deviceId).select().single();
        if (error) throw error;
        log('persisted', key, value, 'device', deviceId);
        selectedDevice.features = data.features;
        editingFeatures = Object.assign({}, data.features);
      } catch (err) {
        log('persistFeatureToggle err', err);
        throw err;
      }
    }

    // Init: restore session explicitly
    (async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          await onAuth(session.user);
        } else {
          log('No session found on init');
        }
      } catch (err) {
        log('init session restore error', err);
      }
    })();

    // Create device — enhanced: detect RLS errors and recover session gracefully
    document.getElementById('create-device-btn').addEventListener('click', async () => {
      if (!selectedProfile) return alert('Select a user first');
      const name = prompt('Device name'); if (!name) return;
      const model = prompt('Device model (optional)') || '';
      const owner = selectedProfile.id;
      try {
        const { data, error } = await supabase.from('devices').insert([{ name, model, owner, features: {} }]).select().single();
        if (error) throw error;
        await loadDevicesForProfile(owner);
        alert('Device created: ' + (data.id || data.name || 'ok'));
      } catch (err) {
        log('create device err', err);
        const msg = (err && (err.message || err.error || JSON.stringify(err))) || String(err);
        if (msg.toLowerCase().includes('row-level security') || msg.toLowerCase().includes('row level security')) {
          try {
            const { data: sessionData } = await supabase.auth.getSession();
            const hasToken = !!sessionData?.session?.access_token;
            log('RLS insert failed — session present?', hasToken);
            if (!hasToken) {
              alert('Session expired after failed insert. Please sign in again.');
              await supabase.auth.signOut();
              await onAuth(null);
              return;
            }
          } catch (e) {
            log('error checking session after RLS failure', e);
          }
        }
        alert('Create device failed: ' + (msg));
      }
    });

    // wire refresh
    document.getElementById('refresh-profiles').addEventListener('click', loadProfiles);
    document.getElementById('refresh-devices').addEventListener('click', async () => {
      if (!selectedProfile) return alert('Select a user first');
      await loadDevicesForProfile(selectedProfile.id);
    });

  </script>
</body>
</html>
