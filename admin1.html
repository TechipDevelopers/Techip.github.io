<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Techip Admin — Users → Devices → Features</title>
  <style>
    :root{--brand:#0b3d91;--muted:#6b7280;--bg:#f7f9fc}
    body{font-family:Inter,system-ui,Roboto,Arial;margin:0;background:var(--bg);color:#0b1a2b;padding:20px}
    header{background:linear-gradient(90deg,var(--brand),#05408b);color:#fff;padding:14px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-size:18px}
    .row{display:flex;gap:12px}
    .container{max-width:1100px;margin:18px auto}
    .col{background:#fff;border-radius:10px;padding:14px;border:1px solid #e6eef8}
    .left{width:300px}
    .mid{flex:1;min-width:320px}
    .right{width:340px}
    .muted{color:var(--muted);font-size:13px}
    button{background:var(--brand);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #e6eef8;color:#0b1a2b}
    ul{list-style:none;padding:0;margin:0}
    li{padding:8px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}
    li.clickable{cursor:pointer}
    .selected{background:#eef6ff}
    .feature{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f6f9fc}
    .switch{display:inline-flex;align-items:center;gap:8px}
    input[type="checkbox"]{width:18px;height:18px}
    pre#debug{background:#0b1a2b;color:#fff;padding:8px;border-radius:8px;max-height:200px;overflow:auto}
    @media(max-width:980px){ .row{flex-direction:column} .left,.right{width:100%} }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Techip Admin</h1>
      <div class="muted">Users → Devices → Feature switches</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="email" type="email" placeholder="admin@example.com" style="padding:8px;border-radius:8px;border:none" />
      <input id="password" type="password" placeholder="Password" style="padding:8px;border-radius:8px;border:none" />
      <button id="signin-btn">Sign in</button>
      <button id="signout-btn" class="ghost" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <!-- Users column -->
      <div class="col left">
        <strong>Users</strong>
        <div class="muted" style="margin-bottom:8px">Click a user to see their devices</div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="refresh-profiles" class="ghost">Refresh</button>
          <div id="profiles-loading" class="muted" style="align-self:center">Idle</div>
        </div>
        <ul id="profiles-list" style="margin-top:8px"></ul>
      </div>

      <!-- Devices column -->
      <div class="col mid">
        <strong id="devices-title">Devices</strong>
        <div class="muted" id="devices-sub">Select a user to list devices</div>
        <div style="display:flex;gap:8px;margin:8px 0">
          <button id="refresh-devices" class="ghost">Refresh devices</button>
          <button id="create-device-btn" class="ghost">Create device</button>
          <div style="flex:1"></div>
          <div id="devices-loading" class="muted">Idle</div>
        </div>
        <table id="devices-table" style="width:100%;border-collapse:collapse;display:none">
          <thead><tr style="text-align:left"><th>ID</th><th>Name</th><th>Model</th><th>Features</th></tr></thead>
          <tbody id="devices-body"></tbody>
        </table>
        <div id="no-devices" class="muted" style="margin-top:8px;display:none">No devices</div>
      </div>

      <!-- Features column -->
      <div class="col right">
        <strong id="device-title">Device Features</strong>
        <div class="muted" id="device-sub">Select a device to edit features</div>
        <div id="selected-device-info" style="margin:10px 0" class="muted"></div>
        <div id="features-list" style="margin-top:8px"></div>
        <div style="margin-top:12px">
          <button id="save-features" style="display:none">Save features</button>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid #eef6ff">
        <div class="muted">Debug</div>
        <pre id="debug">Ready.</pre>
      </div>
    </div>
  </div>

  <script type="module">
    alert('Techip Admin script loaded');

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://cnwerkocgdhimiwuawiv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNud2Vya29jZ2RoaW1pd3Vhd2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTMwMjAsImV4cCI6MjA3NzY2OTAyMH0.X0ewxmFBh2ofhIQGPgDucJk9pQJylXDoLTerxYgrouw';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    // Elements
    const emailInput = document.getElementById('email'), passwordInput = document.getElementById('password');
    const signInBtn = document.getElementById('signin-btn'), signOutBtn = document.getElementById('signout-btn');
    const profilesList = document.getElementById('profiles-list'), refreshProfilesBtn = document.getElementById('refresh-profiles'), profilesLoading = document.getElementById('profiles-loading');
    const devicesTitle = document.getElementById('devices-title'), devicesSub = document.getElementById('devices-sub'), refreshDevicesBtn = document.getElementById('refresh-devices'), devicesLoading = document.getElementById('devices-loading');
    const devicesTable = document.getElementById('devices-table'), devicesBody = document.getElementById('devices-body'), noDevices = document.getElementById('no-devices');
    const deviceTitle = document.getElementById('device-title'), deviceSub = document.getElementById('device-sub'), selectedDeviceInfo = document.getElementById('selected-device-info');
    const featuresList = document.getElementById('features-list'), saveFeaturesBtn = document.getElementById('save-features');
    const debugEl = document.getElementById('debug');

    function log(...args){ console.log(...args); debugEl.textContent = args.map(a=> typeof a==='object'? JSON.stringify(a,null,2): String(a)).join(' '); }

    // Features mapping (keys used in DB JSON)
    const FEATURE_MAP = [
      { key: 'block_play_store', label: 'Block Google Play Store' },
      { key: 'block_developer_options', label: 'Block Developer Options' },
      { key: 'disable_app_settings', label: 'Disable App Settings Control' },
      { key: 'disable_apk_installation', label: 'Disable APK Installation' },
      { key: 'disable_bluetooth', label: 'Disable Bluetooth' },
      { key: 'disable_tethering', label: 'Disable Tethering & Hotspot' },
      { key: 'disable_sms_mms', label: 'Disable SMS/MMS' },
      { key: 'enable_firewall', label: 'Enable Firewall (VPN)' },
      { key: 'enable_private_dns', label: 'Enable Private DNS' },
      { key: 'disable_all_network', label: 'Disable All Network Access' },
      { key: 'disallow_adding_users', label: 'Disallow Adding Users' },
      { key: 'disable_factory_reset', label: 'Disable Factory Reset' },
      { key: 'block_whatsapp_updates_tab', label: 'Block WhatsApp Updates Tab' },
      { key: 'block_inapp_ai_chats', label: 'Block In-App AI Chats' }
    ];

    // state
    let profiles = []; // loaded profiles
    let selectedProfile = null; // profile object
    let devices = []; // devices for selected profile
    let selectedDevice = null; // device object (with features)
    let editingFeatures = {}; // local copy of features for toggling

    // AUTH flows
    signInBtn.addEventListener('click', async ()=>{
      const email = emailInput.value.trim(), password = passwordInput.value;
      if (!email || !password) return alert('Email and password required');
      signInBtn.disabled = true;
      try {
        const res = await supabase.auth.signInWithPassword({ email, password });
        log('signIn', res);
        if (res.error) { alert('Sign-in failed: ' + res.error.message); return; }
        const { data: { user } } = await supabase.auth.getUser();
        await onAuth(user);
      } catch (err) { log('signIn err', err); alert('Sign-in error'); } finally { signInBtn.disabled = false; }
    });

    signOutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut(); await onAuth(null);
    });

    supabase.auth.onAuthStateChange(async (event, session) => {
      log('auth event', event, session);
      await onAuth(session?.user ?? null);
    });

    async function onAuth(user){
      if (!user){
        signOutBtn.style.display = 'none';
        signInBtn.style.display = 'inline-block';
        profilesList.innerHTML = '';
        devicesBody.innerHTML = '';
        featuresList.innerHTML = '';
        selectedDevice = null; selectedProfile = null;
        devicesTable.style.display = 'none'; noDevices.style.display = 'none';
        devicesSub.textContent = 'Select a user to list devices';
        deviceSub.textContent = 'Select a device to edit features';
        log('Signed out');
        return;
      }
      signOutBtn.style.display = 'inline-block';
      signInBtn.style.display = 'none';
      log('Signed in as', user.email || user.id);
      await loadProfiles();
    }

    // Load profiles (users)
    refreshProfilesBtn.addEventListener('click', loadProfiles);

    async function loadProfiles(){
      profilesLoading.textContent = 'Loading…';
      profilesList.innerHTML = '';
      try {
        // Adjust the select as needed; this loads all rows from profiles
        const { data, error } = await supabase.from('profiles').select('id,email,created_at,is_admin').order('created_at',{ascending:false}).limit(1000);
        if (error) throw error;
        profiles = data || [];
        renderProfiles();
        profilesLoading.textContent = 'Loaded';
      } catch (err) {
        profilesLoading.textContent = 'Error';
        log('loadProfiles error', err);
        alert('Failed to load profiles: ' + (err.message || err));
      }
    }

    function renderProfiles(){
      profilesList.innerHTML = '';
      if (!profiles.length) {
        profilesList.innerHTML = '<li class="muted">No users</li>';
        return;
      }
      profiles.forEach(p=>{
        const li = document.createElement('li');
        li.className = 'clickable';
        li.innerHTML = `<div>${escapeHtml(p.email||p.id)}</div><div class="muted">${p.is_admin ? 'admin' : ''}</div>`;
        li.addEventListener('click', ()=> selectProfile(p, li));
        profilesList.appendChild(li);
      });
    }

    // Select profile => load devices for that profile
    async function selectProfile(profile, liEl){
      // UI selection highlight
      Array.from(profilesList.children).forEach(c=>c.classList.remove('selected'));
      liEl.classList.add('selected');
      selectedProfile = profile;
      devicesTitle.textContent = `Devices for ${profile.email||profile.id}`;
      devicesSub.textContent = 'Loading devices…';
      await loadDevicesForProfile(profile.id);
    }

    async function loadDevicesForProfile(profileId){
      devicesLoading.textContent = 'Loading…';
      devicesBody.innerHTML = '';
      selectedDevice = null;
      featuresList.innerHTML = '';
      try {
        // owner field must match profile id; adapt field name if different
        const { data, error } = await supabase.from('devices').select('*').eq('owner', profileId).order('created_at',{ascending:false}).limit(1000);
        if (error) throw error;
        devices = data || [];
        renderDevices();
        devicesLoading.textContent = 'Loaded';
      } catch (err) {
        devicesLoading.textContent = 'Error';
        log('loadDevicesForProfile error', err);
        alert('Failed to load devices: ' + (err.message || err));
      }
    }

    function renderDevices(){
      devicesBody.innerHTML = '';
      if (!devices.length) {
        devicesTable.style.display = 'none';
        noDevices.style.display = 'block';
        return;
      }
      noDevices.style.display = 'none';
      devicesTable.style.display = 'table';
      devices.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(d.id)}</td><td class="clickable name">${escapeHtml(d.name||'')}</td><td>${escapeHtml(d.model||'')}</td><td style="max-width:200px;white-space:pre-wrap">${escapeHtml(JSON.stringify(d.features||{}))}</td>`;
        // clicking row loads device features
        tr.querySelector('.name').addEventListener('click', ()=> selectDevice(d, tr));
        devicesBody.appendChild(tr);
      });
    }

    // Select device => render features with switches
    function selectDevice(device, trEl){
      // highlight selected device row
      Array.from(devicesBody.querySelectorAll('tr')).forEach(r=>r.classList.remove('selected'));
      trEl.classList.add('selected');
      selectedDevice = device;
      editingFeatures = Object.assign({}, device.features || {}); // shallow copy
      deviceTitle.textContent = `Features for ${device.name || device.id}`;
      deviceSub.textContent = `Device ID: ${device.id}`;
      selectedDeviceInfo.textContent = `Model: ${device.model || 'unknown'} • Owner: ${device.owner || ''}`;
      renderFeatures();
      saveFeaturesBtn.style.display = 'inline-block';
    }

    function renderFeatures(){
      featuresList.innerHTML = '';
      for (const f of FEATURE_MAP){
        const row = document.createElement('div');
        row.className = 'feature';
        const left = document.createElement('div');
        left.textContent = f.label;
        const right = document.createElement('div');
        right.className = 'switch';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!editingFeatures[f.key];
        cb.addEventListener('change', ()=> {
          editingFeatures[f.key] = cb.checked;
          // optimistic update: update UI immediately and persist
          persistFeatureToggle(selectedDevice.id, f.key, cb.checked);
        });
        right.appendChild(cb);
        row.appendChild(left);
        row.appendChild(right);
        featuresList.appendChild(row);
      }
    }

    // Persist single feature toggle by merging into device.features
    async function persistFeatureToggle(deviceId, key, value){
      try {
        // get latest features from DB to avoid clobbering concurrent changes
        const { data: latest, error: getErr } = await supabase.from('devices').select('features').eq('id', deviceId).single();
        if (getErr) throw getErr;
        const featuresCurrent = Object.assign({}, latest?.features || {}, { [key]: value });
        const { data, error } = await supabase.from('devices').update({ features: featuresCurrent }).eq('id', deviceId).select().single();
        if (error) throw error;
        // reflect saved state
        selectedDevice.features = data.features;
        editingFeatures = Object.assign({}, data.features);
        log('feature saved', key, value, 'device', deviceId);
        // update devices table row cell display (simple refresh)
        renderDevices();
      } catch (err) {
        log('persistFeatureToggle err', err);
        alert('Failed to save feature: ' + (err.message || err));
        // re-sync checkbox to server value after error
        const cb = Array.from(featuresList.querySelectorAll('input[type="checkbox"]')).find((c, i) => FEATURE_MAP[i].key === key);
        if (cb) cb.checked = !!(selectedDevice.features && selectedDevice.features[key]);
      }
    }

    // Bind refresh devices button (re-load for current profile)
    refreshDevicesBtn.addEventListener('click', async ()=>{
      if (!selectedProfile) return alert('Select a user first');
      await loadDevicesForProfile(selectedProfile.id);
    });

    // initial auth state read
    (async ()=>{
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) await onAuth(user);
      } catch (err) { log('init auth err', err); }
    })();

    // small util
    function escapeHtml(s){ if (s == null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>
</body>
</html>
